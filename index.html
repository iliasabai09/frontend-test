<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
    <title>–¢–µ—Å—Ç ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–π</title>
    <style>
        :root{ color-scheme: dark; }
        *{ box-sizing: border-box; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            min-height:100vh;
            background: radial-gradient(1200px 800px at 15% 20%, rgba(96, 165, 250, .55), transparent 60%),
            radial-gradient(1000px 700px at 80% 30%, rgba(167, 139, 250, .55), transparent 62%),
            radial-gradient(900px 650px at 60% 90%, rgba(34, 197, 94, .35), transparent 60%),
            linear-gradient(180deg, #0b1020 0%, #0a0f1c 100%);
            color:#eef2ff;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .wrap{ max-width:1020px; margin:0 auto; padding: 22px 16px 40px; }

        .glass{
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.14);
            box-shadow: 0 18px 50px rgba(0,0,0,.35);
            backdrop-filter: blur(10px);
            border-radius: 18px;
            padding: 14px;
        }

        .top{
            display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
            margin-bottom: 12px;
        }
        h1{ margin:0; font-size:18px; font-weight:800; letter-spacing:.2px; }

        .meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .pill{
            display:inline-flex; align-items:center; gap:8px;
            padding:7px 10px;
            border-radius:999px;
            background: rgba(255,255,255,.10);
            border: 1px solid rgba(255,255,255,.14);
            font-size:12px;
            color:#e9edff;
            white-space: nowrap;
            font-weight:700;
        }
        .pill strong{ font-weight:900; }

        .pill.level{ border: 1px solid rgba(255,255,255,.18); font-weight:900; }
        .pill.level[data-level="junior"]{
            background: rgba(34,197,94,.18);
            border-color: rgba(34,197,94,.55);
            color: rgba(236,253,245,.95);
        }
        .pill.level[data-level="middle"]{
            background: rgba(249,115,22,.18);
            border-color: rgba(249,115,22,.55);
            color: rgba(255,247,237,.95);
        }
        .pill.level[data-level="senior"]{
            background: rgba(239,68,68,.18);
            border-color: rgba(239,68,68,.55);
            color: rgba(254,242,242,.95);
        }

        .pill.good{
            background: rgba(34,197,94,.18);
            border-color: rgba(34,197,94,.55);
            color: rgba(236,253,245,.95);
        }
        .pill.bad{
            background: rgba(239,68,68,.18);
            border-color: rgba(239,68,68,.55);
            color: rgba(254,242,242,.95);
        }

        .bar{
            height: 10px;
            width:100%;
            border-radius:999px;
            background: rgba(255,255,255,.10);
            border: 1px solid rgba(255,255,255,.12);
            overflow:hidden;
            margin-top: 10px;
        }
        .bar > div{
            height:100%;
            width:0%;
            background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(167,139,250,.95), rgba(34,197,94,.85));
            border-radius:999px;
            transition: width .25s ease;
        }

        .grid{ display:grid; gap:12px; margin-top: 14px; }
        @media (min-width: 920px){ .grid{ grid-template-columns: 1.2fr .8fr; } }

        .card{
            background: rgba(255,255,255,.08);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 18px;
            padding: 14px;
        }

        .stage{ position: relative; }
        .stage.fade-out{ animation: stageFadeOut .16s ease forwards; }
        .stage.fade-in{ animation: stageFadeIn .20s ease forwards; }
        @keyframes stageFadeOut{ from{ opacity:1; transform: translateY(0);} to{ opacity:0; transform: translateY(6px);} }
        @keyframes stageFadeIn{ from{ opacity:0; transform: translateY(-6px);} to{ opacity:1; transform: translateY(0);} }

        .qline{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
        .qtitle{ font-size:16px; line-height:1.35; font-weight:750; margin:6px 0 0; }
        .small{ font-size:12px; color: rgba(238,242,255,.78); }

        .answers{ display:grid; gap:10px; margin-top:12px; }
        .ans{
            border-radius:14px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(255,255,255,.06);
            padding:10px 12px;
            cursor:pointer;
            transition: transform .10s ease, border-color .14s ease, background .14s ease, outline-color .14s ease;
            color:#f3f6ff;
            will-change: transform;
        }
        .ans:hover{ border-color: rgba(255,255,255,.30); transform: translateY(-1px); }
        .ans[data-state="selected"]{ outline: 3px solid rgba(96,165,250,.25); border-color: rgba(96,165,250,.55); }

        .answers.reveal .ans[data-state="correct"]{ animation: popCorrect .22s ease both; }
        .answers.reveal .ans[data-state="wrong"]{ animation: shakeWrong .28s ease both; }
        @keyframes popCorrect{
            0%{ transform: translateY(0) scale(1); box-shadow:none; }
            60%{ transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 22px rgba(34,197,94,.18); }
            100%{ transform: translateY(0) scale(1); box-shadow: 0 8px 18px rgba(34,197,94,.12); }
        }
        @keyframes shakeWrong{
            0%{ transform: translateX(0); }
            25%{ transform: translateX(-5px); }
            50%{ transform: translateX(5px); }
            75%{ transform: translateX(-3px); }
            100%{ transform: translateX(0); }
        }

        .ans[data-state="correct"]{ border-color: rgba(34,197,94,.75); background: rgba(34,197,94,.16); }
        .ans[data-state="wrong"]{ border-color: rgba(248,113,113,.75); background: rgba(248,113,113,.14); }

        .btns{ display:grid; gap:10px; margin-top: 12px; }
        @media (min-width: 720px){ .btns{ grid-template-columns: 1fr 1fr 1fr; } }

        button{
            border:0;
            border-radius:14px;
            padding: 11px 12px;
            font-weight:800;
            cursor:pointer;
            background: linear-gradient(90deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
            color:#0b1020;
            transition: transform .10s ease, filter .12s ease;
            min-height: 44px;
        }
        button:hover{ transform: translateY(-1px); filter: brightness(1.03); }
        button.secondary{
            background: rgba(255,255,255,.12);
            color:#eef2ff;
            border: 1px solid rgba(255,255,255,.18);
        }
        button.danger{
            background: rgba(239,68,68,.18);
            color:#fff;
            border: 1px solid rgba(239,68,68,.40);
        }
        button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

        .hr{ height:1px; background: rgba(255,255,255,.12); margin: 12px 0; }
        .hidden{ display:none !important; }

        .explain{
            border-radius:16px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.18);
            padding:12px;
            margin-top:12px;
            transform-origin: top;
        }
        .explain.open{ animation: slideDown .22s ease both; }
        .explain.close{ animation: slideUp .18s ease both; }
        @keyframes slideDown{ from{ opacity:0; transform: translateY(-6px) scaleY(.96);} to{ opacity:1; transform: translateY(0) scaleY(1);} }
        @keyframes slideUp{ from{ opacity:1; transform: translateY(0) scaleY(1);} to{ opacity:0; transform: translateY(-6px) scaleY(.96);} }

        .explain h3{ margin:0 0 10px; font-size:14px; }
        .explain .row{ display:grid; gap:10px; }
        .explain .item{
            border-radius:12px;
            padding:10px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.12);
            color: rgba(238,242,255,.92);
            font-size:13px;
            line-height:1.35;
        }

        .settings{ display:grid; gap:10px; margin-top:10px; }
        .field{ display:grid; gap:6px; }
        .field label{ font-size:12px; color: rgba(238,242,255,.80); }
        .field input{
            width:100%;
            padding:10px 12px;
            border-radius:14px;
            border: 1px solid rgba(255,255,255,.18);
            background: rgba(255,255,255,.08);
            color:#eef2ff;
            outline:none;
            font-weight:700;
            min-height: 44px;
        }

        @media (max-width: 520px){
            .wrap{ padding-left: 12px; padding-right: 12px; }
            .glass{ padding: 12px; }
            h1{ font-size: 16px; }
            .pill{ font-size: 11px; padding: 6px 9px; }
            .qtitle{ font-size: 15px; }
            .card{ padding: 12px; border-radius: 16px; }
            .ans{ padding: 10px 11px; }
            .btns{ grid-template-columns: 1fr 1fr; }
            .btns .fullrow{ grid-column: 1 / -1; }
        }
    </style>
</head>
<body>
<!-- üîä Sounds -->
<audio id="soundSuccess" src="./applepay.mp3" preload="auto"></audio>
<audio id="soundError" src="./erro.mp3" preload="auto"></audio>
<div class="wrap">
    <div class="glass" id="header">
        <div class="top">
            <h1 id="titleH">–¢–µ—Å—Ç</h1>
            <div class="meta">
                <span class="pill" id="statusPill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
                <span class="pill">–í —Å–µ—Å—Å–∏–∏: <strong id="totalQ">0</strong></span>
                <span class="pill">–ü—Ä–æ–π–¥–µ–Ω–æ: <strong id="doneQ">0</strong></span>
                <span class="pill good">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: <strong id="correctQ">0</strong></span>
                <span class="pill bad">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: <strong id="wrongQ">0</strong></span>
                <span class="pill">‚è±Ô∏è <strong id="timerText">‚Äî</strong></span>
                <span class="pill level" id="lvlBadge" data-level="">
            –£—Ä–æ–≤–µ–Ω—å: <strong id="lvlPill">‚Äî</strong>
          </span>
            </div>
        </div>
        <div class="small" id="subline">–ü–æ–¥–∫–ª—é—á–∏ <b>questions.json</b> —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º.</div>
        <div class="bar"><div id="barFill"></div></div>
    </div>

    <div class="grid">
        <!-- LEFT -->
        <div class="card">
            <div class="stage" id="stage">
                <div class="qline">
                    <div>
                        <div class="small" id="topicLine">‚Äî</div>
                        <div class="qtitle" id="qText">–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–µ—Å—Å–∏—é –∏ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª</div>
                    </div>
                    <span class="pill" id="idxPill">0/0</span>
                </div>

                <div class="answers" id="answers"></div>

                <div class="btns">
                    <button id="backBtn" class="secondary" disabled>–ù–∞–∑–∞–¥</button>
                    <button id="nextBtn" disabled>–ù–∞—á–∞—Ç—å</button>
                    <button id="clarifyBtn" class="secondary fullrow" disabled>–ü—Ä–æ—è—Å–Ω–∏—Ç—å</button>
                </div>

                <div id="explainBox" class="explain hidden">
                    <h3>–†–∞–∑–±–æ—Ä</h3>
                    <div class="row" id="explainInner"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
            <div class="small" style="font-weight:800;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
            <div class="hr"></div>

            <div class="small" id="bankStats">‚Äî</div>

            <div class="settings">
                <div class="field">
                    <label for="countInput">–°–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ—Å—Å–∏–∏</label>
                    <input id="countInput" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 20 –∏–ª–∏ 60" value="60" />
                </div>

                <div class="field">
                    <label for="minutesInput">–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (–º–∏–Ω—É—Ç—ã) ‚Äî –º–æ–∂–Ω–æ –ø—É—Å—Ç–æ</label>
                    <input id="minutesInput" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 90 (–º–æ–∂–Ω–æ –ø—É—Å—Ç–æ)" />
                </div>

                <button id="generateBtn" class="secondary" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é</button>
                <button id="applyTimeBtn" class="secondary" disabled>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è (–¥–æ —Å—Ç–∞—Ä—Ç–∞)</button>
            </div>

            <div class="hr"></div>

            <div class="btns" style="grid-template-columns: 1fr;">
                <button id="restartBtn" class="secondary" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ)</button>
                <button id="jumpBtn" class="secondary" disabled>–°–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å</button>
                <button id="resetProgressBtn" class="danger" disabled>–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (seen/wrong)</button>
            </div>

            <div class="hr"></div>

            <div class="small">
                –õ–æ–≥–∏–∫–∞ –ø–æ–¥–±–æ—Ä–∞:
                <ul>
                    <li>–°–Ω–∞—á–∞–ª–∞ –±–µ—Ä—ë–º <b>–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</b> (–µ—Å–ª–∏ –µ—Å—Ç—å), —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ—à–∏–±–∫–∏.</li>
                    <li>–ü–æ—Ç–æ–º –¥–æ–±–∏—Ä–∞–µ–º <b>–Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</b> (—Ç–æ, —á—Ç–æ —Ç—ã –µ—â—ë –Ω–µ –≤–∏–¥–µ–ª).</li>
                    <li>–ï—Å–ª–∏ –≤—Å—ë —É–∂–µ –≤–∏–¥–µ–ª ‚Äî –¥–æ–±–∏—Ä–∞–µ–º –∏–∑ –ª—é–±—ã—Ö.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== Sounds (applepay.mp3 / erro.mp3) =====
    let soundUnlocked = false;

    function unlockSoundsOnce(){
        if (soundUnlocked) return;
        soundUnlocked = true;

        // First interaction unlock (Chrome/Safari)
        const ok = document.getElementById('soundSuccess');
        const er = document.getElementById('soundError');
        ok && ok.play().then(()=>{ ok.pause(); ok.currentTime = 0; }).catch(()=>{});
        er && er.play().then(()=>{ er.pause(); er.currentTime = 0; }).catch(()=>{});
    }

    function playSuccessSound(){
        if (!soundUnlocked) return;
        const a = document.getElementById('soundSuccess');
        if (!a) return;
        a.currentTime = 0;
        a.play().catch(()=>{});
    }

    function playErrorSound(){
        if (!soundUnlocked) return;
        const a = document.getElementById('soundError');
        if (!a) return;
        a.currentTime = 0;
        a.play().catch(()=>{});
    }

    document.addEventListener('pointerdown', unlockSoundsOnce, { once: true });

    const LS_SEEN = 'quiz_seen_ids_v1';
    const LS_WRONG = 'quiz_wrong_ids_v1';

    const els = {
        stage: document.getElementById('stage'),

        titleH: document.getElementById('titleH'),
        status: document.getElementById('statusPill'),
        totalQ: document.getElementById('totalQ'),
        doneQ: document.getElementById('doneQ'),
        correctQ: document.getElementById('correctQ'),
        wrongQ: document.getElementById('wrongQ'),
        idxPill: document.getElementById('idxPill'),
        barFill: document.getElementById('barFill'),
        subline: document.getElementById('subline'),

        timerText: document.getElementById('timerText'),

        lvlPill: document.getElementById('lvlPill'),
        lvlBadge: document.getElementById('lvlBadge'),

        topicLine: document.getElementById('topicLine'),
        qText: document.getElementById('qText'),
        answers: document.getElementById('answers'),

        backBtn: document.getElementById('backBtn'),
        nextBtn: document.getElementById('nextBtn'),
        clarifyBtn: document.getElementById('clarifyBtn'),

        explainBox: document.getElementById('explainBox'),
        explainInner: document.getElementById('explainInner'),

        bankStats: document.getElementById('bankStats'),
        countInput: document.getElementById('countInput'),
        minutesInput: document.getElementById('minutesInput'),
        generateBtn: document.getElementById('generateBtn'),
        applyTimeBtn: document.getElementById('applyTimeBtn'),
        restartBtn: document.getElementById('restartBtn'),
        jumpBtn: document.getElementById('jumpBtn'),
        resetProgressBtn: document.getElementById('resetProgressBtn'),
    };

    let DB = null;

    // bank arrays by level (flattened)
    let bankByLevel = { junior: [], middle: [], senior: [] };
    let bankTotal = 0;

    // session
    let pool = [];
    let idx = -1;
    let isFinished = false;

    // timer rules
    let hasStarted = false;

    // per-question state (session)
    let qState = [];
    let correctCount = 0;
    let wrongCount = 0;

    // timer
    let timerId = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;

    // progress cache
    let seenSet = new Set();
    let wrongSet = new Set();

    // ---------- helpers ----------
    function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, m => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
    }
    function toTitle(s) { return s ? s[0].toUpperCase() + s.slice(1) : '‚Äî'; }
    function setStatus(text) { els.status.textContent = text; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    // stable hash (FNV-1a-ish)
    function hashString(str){
        let h = 2166136261;
        for (let i=0;i<str.length;i++){
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        return (h >>> 0).toString(16);
    }

    function makeQuestionId(item){
        const q = item.q || {};
        const payload = [
            item.level, item.competency, item.theme,
            q.question, q.var_1, q.var_2, q.var_3, q.var_4,
            q.correct_position, q.correct_answer
        ].map(x => String(x ?? '')).join('|');
        return hashString(payload);
    }

    function loadSets(){
        try{
            const seen = JSON.parse(localStorage.getItem(LS_SEEN) || '[]');
            const wrong = JSON.parse(localStorage.getItem(LS_WRONG) || '[]');
            seenSet = new Set(Array.isArray(seen) ? seen : []);
            wrongSet = new Set(Array.isArray(wrong) ? wrong : []);
        }catch{
            seenSet = new Set();
            wrongSet = new Set();
        }
    }

    function persistSets(){
        try{
            localStorage.setItem(LS_SEEN, JSON.stringify([...seenSet]));
            localStorage.setItem(LS_WRONG, JSON.stringify([...wrongSet]));
        }catch{}
    }

    function updateBankStatsUI(){
        const seenCount = seenSet.size;
        const wrongCountAll = wrongSet.size;

        const j = bankByLevel.junior.length;
        const m = bankByLevel.middle.length;
        const s = bankByLevel.senior.length;

        els.bankStats.innerHTML = `
      <div>–ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤: <b>${bankTotal}</b> (Junior: <b>${j}</b> ‚Ä¢ Middle: <b>${m}</b> ‚Ä¢ Senior: <b>${s}</b>)</div>
      <div>–ü—Ä–æ–≥—Ä–µ—Å—Å: –≤–∏–¥–µ–ª <b>${seenCount}</b> / ${bankTotal} ‚Ä¢ –≤ –æ—à–∏–±–∫–∞—Ö <b>${wrongCountAll}</b></div>
    `;

        const desired = Number(els.countInput.value || 60);
        els.titleH.textContent = `–¢–µ—Å—Ç: —Å–µ—Å—Å–∏—è ${Number.isFinite(desired) && desired > 0 ? desired : 60} –≤–æ–ø—Ä–æ—Å–æ–≤`;
    }

    // ---------- timer ----------
    function formatTimeSigned(sec) {
        const s = sec | 0;
        const neg = s < 0;
        const abs = Math.abs(s);
        const mm = String(Math.floor(abs / 60)).padStart(2, '0');
        const ss = String(abs % 60).padStart(2, '0');
        return (neg ? '-' : '') + `${mm}:${ss}`;
    }

    function stopTimer() { if (timerId) clearInterval(timerId); timerId = null; }

    function startTimerMaybe(minutesValue) {
        stopTimer();

        const raw = String(minutesValue ?? '').trim();
        if (raw === '') { els.timerText.textContent = '‚Äî'; return; }

        const mins = Number(raw);
        if (!Number.isFinite(mins) || mins <= 0) { els.timerText.textContent = '‚Äî'; return; }

        totalSeconds = Math.floor(mins * 60);
        remainingSeconds = totalSeconds;
        els.timerText.textContent = formatTimeSigned(remainingSeconds);

        timerId = setInterval(() => {
            if (isFinished) return;
            remainingSeconds -= 1; // goes negative
            els.timerText.textContent = formatTimeSigned(remainingSeconds);
        }, 1000);
    }

    // ---------- UI state ----------
    function updateCountersUI(){
        els.correctQ.textContent = String(correctCount);
        els.wrongQ.textContent = String(wrongCount);
    }

    function updateProgressUI() {
        const total = pool.length;
        const done = Math.max(0, idx);
        els.totalQ.textContent = String(total);
        els.doneQ.textContent = String(Math.min(done, total));
        els.idxPill.textContent = total && idx >= 0 ? `${Math.min(idx + 1, total)}/${total}` : `0/${total || 0}`;
        const percent = total && idx >= 0 ? (Math.min(idx, total) / total) * 100 : 0;
        els.barFill.style.width = `${clamp(percent, 0, 100)}%`;
        els.backBtn.disabled = (idx <= 0) || isFinished;
    }

    function closeExplainAnimated() {
        if (els.explainBox.classList.contains('hidden')) return;
        els.explainBox.classList.remove('open');
        els.explainBox.classList.add('close');
        setTimeout(() => {
            els.explainBox.classList.add('hidden');
            els.explainBox.classList.remove('close');
            els.explainInner.innerHTML = '';
        }, 180);
    }
    function openExplainAnimated() {
        els.explainBox.classList.remove('hidden');
        els.explainBox.classList.remove('close');
        els.explainBox.classList.add('open');
        setTimeout(() => els.explainBox.classList.remove('open'), 240);
    }
    function resetExplain() {
        els.explainInner.innerHTML = '';
        els.explainBox.classList.add('hidden');
        els.explainBox.classList.remove('open', 'close');
    }

    function animateStageSwap(renderFn) {
        els.stage.classList.remove('fade-in');
        els.stage.classList.add('fade-out');
        setTimeout(() => {
            renderFn();
            els.stage.classList.remove('fade-out');
            els.stage.classList.add('fade-in');
            setTimeout(() => els.stage.classList.remove('fade-in'), 220);
        }, 160);
    }

    // ---------- explain ----------
    function getReason(q, n) {
        const info = q?.[`var_${n}_info`];
        return info?.reason || '';
    }

    function showExplain() {
        const item = pool[idx];
        if (!item) return;

        const q = item.q;
        const correct = Number(q.correct_position);

        const st = qState[idx] || { selected: null, revealed: false, isCorrect: null };
        const chosen = st.selected;

        const correctReason = getReason(q, correct) ||
            '–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞ –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–∂–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π.';
        const selReason = chosen ? (getReason(q, chosen) || '‚Äî') : '‚Äî';

        const blocks = [];

        blocks.push(`
      <div class="item">
        <b>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</b><br/>
        ${esc(q.correct_answer || q[`var_${correct}`] || '‚Äî')}
      </div>
    `);

        blocks.push(`
      <div class="item">
        <b>–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:</b><br/>
        ${esc(correctReason)}
      </div>
    `);

        for (let n = 1; n <= 4; n++) {
            const isCorrect = (n === correct);
            const reason = getReason(q, n) || (isCorrect
                    ? '–≠—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ —Å–º—ã—Å–ª—É.'
                    : '–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω–æ, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫—É/–Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–æ–ø—Ä–æ—Å–∞.'
            );
            blocks.push(`
        <div class="item">
          <b>–í–∞—Ä–∏–∞–Ω—Ç ${n}${isCorrect ? ' (–≤–µ—Ä–Ω—ã–π)' : ''}:</b><br/>
          ${esc(q[`var_${n}`] || '‚Äî')}
          <div style="margin-top:6px; opacity:.9;"><b>–ü–æ—á–µ–º—É:</b> ${esc(reason)}</div>
        </div>
      `);
        }

        if (chosen) {
            blocks.unshift(`
        <div class="item">
          <b>–¢–≤–æ–π –≤—ã–±–æ—Ä:</b> –≤–∞—Ä–∏–∞–Ω—Ç ${chosen}<br/>
          <b>–ü–æ—á–µ–º—É:</b> ${esc(selReason)}
        </div>
      `);
        }

        els.explainInner.innerHTML = blocks.join('');
        openExplainAnimated();
    }

    function toggleExplain() {
        if (els.explainBox.classList.contains('hidden')) showExplain();
        else closeExplainAnimated();
    }

    // ---------- render ----------
    function renderQuestion() {
        resetExplain();
        els.answers.classList.remove('reveal');

        const item = pool[idx];
        if (!item) return;

        const { level, competency, theme, q } = item;

        const lvl = String(level || '').toLowerCase();
        els.lvlPill.textContent = toTitle(level);
        els.lvlBadge.setAttribute('data-level', lvl);

        els.topicLine.textContent = `${toTitle(level)} ‚Ä¢ ${competency} ‚Ä¢ ${theme}`;
        els.qText.textContent = q.question || '(–Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞)';

        const st = qState[idx] || { selected: null, revealed: false, isCorrect: null };

        const options = [
            { k: 1, text: q.var_1 },
            { k: 2, text: q.var_2 },
            { k: 3, text: q.var_3 },
            { k: 4, text: q.var_4 },
        ];

        els.answers.innerHTML = '';
        for (const opt of options) {
            const div = document.createElement('div');
            div.className = 'ans';
            div.dataset.k = String(opt.k);
            div.dataset.state = 'idle';
            div.innerHTML = esc(opt.text || '(–ø—É—Å—Ç–æ)');

            div.addEventListener('click', () => {
                if (isFinished) return;
                const cur = qState[idx] || { selected: null, revealed: false, isCorrect: null };
                if (cur.revealed) return;

                cur.selected = opt.k;
                qState[idx] = cur;

                [...els.answers.children].forEach(x => x.dataset.state = 'idle');
                div.dataset.state = 'selected';

                els.nextBtn.disabled = false;
                els.nextBtn.textContent = '–î–∞–ª—å—à–µ';
                els.clarifyBtn.disabled = true;
                closeExplainAnimated();
            });

            els.answers.appendChild(div);
        }

        // restore selection/reveal
        if (st.selected) {
            const node = [...els.answers.children].find(n => Number(n.dataset.k) === st.selected);
            if (node) node.dataset.state = 'selected';
            els.nextBtn.disabled = false;
            els.nextBtn.textContent = st.revealed ? '–°–ª–µ–¥—É—é—â–∏–π' : '–î–∞–ª—å—à–µ';
        } else {
            els.nextBtn.disabled = true;
            els.nextBtn.textContent = idx === -1 ? '–ù–∞—á–∞—Ç—å' : '–î–∞–ª—å—à–µ';
        }

        if (st.revealed) {
            const correct = Number(q.correct_position);
            [...els.answers.children].forEach(node => {
                const k = Number(node.dataset.k);
                if (k === correct) node.dataset.state = 'correct';
                else if (k === st.selected) node.dataset.state = 'wrong';
                else node.dataset.state = 'idle';
            });

            els.answers.classList.remove('reveal');
            void els.answers.offsetWidth;
            els.answers.classList.add('reveal');

            els.clarifyBtn.disabled = false;
        } else {
            els.clarifyBtn.disabled = true;
        }

        updateProgressUI();
    }

    function revealAnswer() {
        const item = pool[idx];
        if (!item) return;

        const q = item.q;
        const correct = Number(q.correct_position);

        const st = qState[idx] || { selected: null, revealed: false, isCorrect: null };
        if (!st.selected) return;

        if (!st.revealed) {
            st.revealed = true;
            st.isCorrect = (st.selected === correct);
            qState[idx] = st;

            // mark progress in cache
            const qid = item._id;
            seenSet.add(qid);
            if (st.isCorrect) {
                correctCount++;
                wrongSet.delete(qid); // –µ—Å–ª–∏ –≤—ã—É—á–∏–ª ‚Äî —É–±–∏—Ä–∞–µ–º –∏–∑ "–æ—à–∏–±–æ–∫"
                playSuccessSound(); // üçè applepay.mp3
            } else {
                wrongCount++;
                wrongSet.add(qid);
                playErrorSound(); // ‚ùå erro.mp3
            }
            persistSets();
            updateBankStatsUI();
            updateCountersUI();
        }

        [...els.answers.children].forEach(node => {
            const k = Number(node.dataset.k);
            if (k === correct) node.dataset.state = 'correct';
            else if (k === st.selected) node.dataset.state = 'wrong';
            else node.dataset.state = 'idle';
        });

        els.answers.classList.remove('reveal');
        void els.answers.offsetWidth;
        els.answers.classList.add('reveal');

        els.clarifyBtn.disabled = false;
        els.nextBtn.disabled = false;
        els.nextBtn.textContent = '–°–ª–µ–¥—É—é—â–∏–π';
    }

    // ---------- selection logic ----------
    function getDesiredCount(){
        const raw = Number(els.countInput.value || 60);
        if (!Number.isFinite(raw) || raw <= 0) return 60;
        return Math.max(1, Math.floor(raw));
    }

    function computeDistribution(totalCount){
        // near-even split across 3 levels
        const levels = ['junior','middle','senior'];
        const base = Math.floor(totalCount / 3);
        let rem = totalCount - base*3;
        const counts = { junior: base, middle: base, senior: base };

        // remainder: give to levels with more "unseen" first
        const unseenCounts = {};
        for (const lv of levels){
            unseenCounts[lv] = bankByLevel[lv].filter(x => !seenSet.has(x._id)).length;
        }
        const order = levels.slice().sort((a,b) => unseenCounts[b]-unseenCounts[a]);

        let i=0;
        while(rem>0){
            counts[order[i % order.length]]++;
            rem--;
            i++;
        }

        // ensure we don't ask more than available per level (fallback later)
        return counts;
    }

    function pickForLevel(levelKey, count){
        const all = bankByLevel[levelKey].slice();
        if (all.length === 0 || count <= 0) return [];

        // pools
        const wrongPool = all.filter(x => wrongSet.has(x._id));
        const unseenPool = all.filter(x => !seenSet.has(x._id) && !wrongSet.has(x._id));
        const restPool = all.filter(x => seenSet.has(x._id) && !wrongSet.has(x._id));

        shuffle(wrongPool);
        shuffle(unseenPool);
        shuffle(restPool);

        // wrong quota (so wrong "–º–æ–∂–µ—Ç –ø–æ–ø–∞–¥–∞—Ç—å", –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞—Å—Ç–æ)
        let wrongQuota = Math.floor(count * 0.4);
        if (wrongPool.length > 0 && wrongQuota === 0) wrongQuota = 1;
        wrongQuota = Math.min(wrongQuota, count, wrongPool.length);

        const selected = [];
        selected.push(...wrongPool.slice(0, wrongQuota));

        const left1 = count - selected.length;
        if (left1 > 0) selected.push(...unseenPool.slice(0, left1));

        const left2 = count - selected.length;
        if (left2 > 0) selected.push(...restPool.slice(0, left2));

        // if still not enough (level bank smaller), just return what we have
        return selected.slice(0, count);
    }

    function buildSessionPool(totalCount){
        const counts = computeDistribution(totalCount);

        let chosen = [
            ...pickForLevel('junior', counts.junior),
            ...pickForLevel('middle', counts.middle),
            ...pickForLevel('senior', counts.senior),
        ];

        // if due to small bank, chosen < totalCount -> fill from any level prioritizing unseen then rest
        if (chosen.length < totalCount){
            const need = totalCount - chosen.length;
            const all = [...bankByLevel.junior, ...bankByLevel.middle, ...bankByLevel.senior];

            const already = new Set(chosen.map(x => x._id));
            const wrongAny = all.filter(x => wrongSet.has(x._id) && !already.has(x._id));
            const unseenAny = all.filter(x => !seenSet.has(x._id) && !wrongSet.has(x._id) && !already.has(x._id));
            const restAny = all.filter(x => !already.has(x._id) && !wrongSet.has(x._id) && seenSet.has(x._id));

            shuffle(wrongAny); shuffle(unseenAny); shuffle(restAny);

            const filler = [];
            // keep wrong included
            filler.push(...wrongAny.slice(0, Math.min(need, Math.max(0, Math.floor(need*0.4)) || (wrongAny.length?1:0))));
            while (filler.length < need && unseenAny.length){
                filler.push(unseenAny.shift());
            }
            while (filler.length < need && restAny.length){
                filler.push(restAny.shift());
            }

            chosen = chosen.concat(filler.slice(0, need));
        }

        return shuffle(chosen).slice(0, totalCount);
    }

    // ---------- lifecycle ----------
    function prepareSession(){
        isFinished = false;
        idx = -1;

        const desired = getDesiredCount();
        pool = buildSessionPool(desired);

        // reset session state
        qState = new Array(pool.length).fill(null).map(() => ({ selected: null, revealed: false, isCorrect: null }));
        correctCount = 0;
        wrongCount = 0;
        updateCountersUI();

        resetExplain();
        els.answers.classList.remove('reveal');

        els.totalQ.textContent = String(pool.length);
        els.doneQ.textContent = '0';
        els.idxPill.textContent = `0/${pool.length}`;
        els.barFill.style.width = '0%';

        els.topicLine.textContent = '‚Äî';
        els.qText.textContent = '–°–µ—Å—Å–∏—è –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª';
        els.answers.innerHTML = '';

        els.lvlPill.textContent = '‚Äî';
        els.lvlBadge.setAttribute('data-level', '');

        els.nextBtn.disabled = false;
        els.nextBtn.textContent = '–ù–∞—á–∞—Ç—å';
        els.backBtn.disabled = true;
        els.clarifyBtn.disabled = true;

        // timer settings allowed before start
        hasStarted = false;
        els.minutesInput.disabled = false;
        els.applyTimeBtn.disabled = false;

        // update header title
        els.titleH.textContent = `–¢–µ—Å—Ç: —Å–µ—Å—Å–∏—è ${pool.length} –≤–æ–ø—Ä–æ—Å–æ–≤`;

        // timer is NOT auto-started here; start only when user presses "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" or leave blank
        // (but you asked "—Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ" ‚Äî –∑–Ω–∞—á–∏—Ç –¥–æ —Å—Ç–∞—Ä—Ç–∞ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)
        if (String(els.timerText.textContent || '').trim() === '') els.timerText.textContent = '‚Äî';

        updateProgressUI();
    }

    function nextOrReveal() {
        if (isFinished) return;

        // start test
        if (idx === -1) {
            animateStageSwap(() => {
                idx = 0;

                // lock timer settings after start
                hasStarted = true;
                els.minutesInput.disabled = true;
                els.applyTimeBtn.disabled = true;

                renderQuestion();
                setStatus('–ò–¥—ë—Ç —Ç–µ—Å—Ç');
                els.subline.innerHTML = `–°–µ—Å—Å–∏—è: <b>${pool.length}</b> –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Ä¢ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ + –æ—à–∏–±–∫–∏.`;
            });
            return;
        }

        const st = qState[idx];
        if (!st.revealed) {
            revealAnswer();
            return;
        }

        animateStageSwap(() => {
            closeExplainAnimated();
            idx++;
            if (idx >= pool.length) {
                finishTest("–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã üéâ");
                return;
            }
            renderQuestion();
        });
    }

    function prevQuestion() {
        if (isFinished) return;
        if (idx <= 0) return;
        animateStageSwap(() => {
            closeExplainAnimated();
            idx--;
            renderQuestion();
        });
    }

    function jumpRandom() {
        if (!pool.length || isFinished) return;
        animateStageSwap(() => {
            closeExplainAnimated();
            idx = Math.floor(Math.random() * pool.length);
            renderQuestion();
        });
    }

    function finishTest(reason) {
        isFinished = true;
        stopTimer();

        els.answers.innerHTML = '';
        els.topicLine.textContent = '‚Äî';
        els.qText.textContent = `–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. ${reason}`;
        els.idxPill.textContent = `${pool.length}/${pool.length}`;
        els.barFill.style.width = '100%';

        els.nextBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ';
        els.nextBtn.disabled = false;

        els.backBtn.disabled = true;
        els.clarifyBtn.disabled = true;

        els.lvlPill.textContent = '‚Äî';
        els.lvlBadge.setAttribute('data-level', '');

        closeExplainAnimated();

        // allow timer setting again (before next start)
        hasStarted = false;
        els.minutesInput.disabled = false;
        els.applyTimeBtn.disabled = false;
        setStatus('–ì–æ—Ç–æ–≤–æ');
    }

    // ---------- bank building ----------
    function buildAllByLevelFromDB(){
        const out = { junior: [], middle: [], senior: [] };
        const levels = DB?.levels ? Object.keys(DB.levels) : [];
        for (const levelKey of levels) {
            const themes = DB.levels[levelKey]?.themes || [];
            for (const t of themes) {
                for (const q of (t.questions || [])) {
                    const item = {
                        level: levelKey,
                        competency: t.competency,
                        theme: t.theme,
                        q,
                    };
                    item._id = makeQuestionId(item);
                    (out[levelKey] || []).push(item);
                }
            }
        }
        return out;
    }

    function resetProgress(){
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –ë—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã —Å–ø–∏—Å–∫–∏ "–≤–∏–¥–µ–ª" –∏ "–æ—à–∏–±–∫–∏".')) return;
        seenSet.clear();
        wrongSet.clear();
        persistSets();
        updateBankStatsUI();
    }

    // ---------- actions ----------
    function applyTime() {
        if (isFinished) return;
        if (hasStarted) return; // only before start
        startTimerMaybe(els.minutesInput.value);
    }

    function onGenerate(){
        prepareSession();
        setStatus('–°–µ—Å—Å–∏—è –≥–æ—Ç–æ–≤–∞');
        els.subline.innerHTML = `–ì–æ—Ç–æ–≤–æ: <b>${pool.length}</b> –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Ä¢ –Ω–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª.`;
    }

    async function init() {
        try {
            loadSets();
            setStatus('–ó–∞–≥—Ä—É–∂–∞—é questions.json‚Ä¶');
            const res = await fetch('./OB_1C_25P.json', { cache: 'no-store' });
            if (!res.ok) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω questions.json —Ä—è–¥–æ–º —Å index.html');

            DB = await res.json();

            bankByLevel = buildAllByLevelFromDB();
            bankTotal = bankByLevel.junior.length + bankByLevel.middle.length + bankByLevel.senior.length;

            updateBankStatsUI();

            // enable controls
            els.generateBtn.disabled = false;
            els.applyTimeBtn.disabled = false;
            els.restartBtn.disabled = false;
            els.jumpBtn.disabled = false;
            els.resetProgressBtn.disabled = false;

            // initial session
            onGenerate();

            setStatus('–ì–æ—Ç–æ–≤–æ');
        } catch (e) {
            console.error(e);
            setStatus('–û—à–∏–±–∫–∞');
            els.subline.textContent = String(e?.message || e);
            els.nextBtn.disabled = true;
        }
    }

    // ---------- events ----------
    els.countInput.addEventListener('input', () => {
        updateBankStatsUI();
    });

    els.generateBtn.addEventListener('click', onGenerate);

    els.restartBtn.addEventListener('click', () => {
        onGenerate();
    });

    els.nextBtn.addEventListener('click', () => {
        // if finished: regenerate and allow start
        if (els.nextBtn.textContent.includes('–∑–∞–Ω–æ–≤–æ')) {
            onGenerate();
            return;
        }
        nextOrReveal();
    });

    els.backBtn.addEventListener('click', prevQuestion);
    els.clarifyBtn.addEventListener('click', toggleExplain);
    els.jumpBtn.addEventListener('click', jumpRandom);
    els.applyTimeBtn.addEventListener('click', applyTime);
    els.resetProgressBtn.addEventListener('click', resetProgress);

    init();
</script>
</body>
</html>
